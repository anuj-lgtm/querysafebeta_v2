{% extends 'user_querySafe/include/base.html' %}
{% load static %}

{% block title %}Analytics | {{ block.super }}{% endblock %}

{% block content %}
<div class="container-fluid py-2">
  <div class="row">
    <div class="col-12">
      <div class="card my-4">
        <!-- Header -->
        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
          <div class="d-flex justify-content-between align-items-center bg-gradient-primary shadow-dark border-radius-lg pt-4 pb-3 px-3 flex-wrap gap-2">
            <h6 class="text-white text-capitalize mb-0">
              <i class="material-symbols-rounded align-middle me-1">bar_chart</i>
              Analytics
              {% if selected_bot %}<span class="opacity-8 ms-1">- {{ selected_bot.name }}</span>{% endif %}
            </h6>
            <div class="d-flex align-items-center gap-2 flex-wrap">
              <!-- Chatbot filter -->
              <select id="chatbot-filter" class="form-select form-select-sm bg-white text-dark" style="width:auto;min-width:140px;">
                <option value="">All Chatbots</option>
                {% for bot in chatbots %}
                <option value="{{ bot.chatbot_id }}" {% if selected_bot and selected_bot.chatbot_id == bot.chatbot_id %}selected{% endif %}>{{ bot.name }}</option>
                {% endfor %}
              </select>
              <!-- Date range -->
              <div class="btn-group btn-group-sm" role="group">
                <a href="?range=7{% if selected_bot %}&chatbot_id={{ selected_bot.chatbot_id }}{% endif %}"
                   class="btn {% if range == '7' %}btn-white text-dark{% else %}btn-outline-white{% endif %}">7d</a>
                <a href="?range=30{% if selected_bot %}&chatbot_id={{ selected_bot.chatbot_id }}{% endif %}"
                   class="btn {% if range == '30' %}btn-white text-dark{% else %}btn-outline-white{% endif %}">30d</a>
                <a href="?range=90{% if selected_bot %}&chatbot_id={{ selected_bot.chatbot_id }}{% endif %}"
                   class="btn {% if range == '90' %}btn-white text-dark{% else %}btn-outline-white{% endif %}">90d</a>
                <a href="?range=all{% if selected_bot %}&chatbot_id={{ selected_bot.chatbot_id }}{% endif %}"
                   class="btn {% if range == 'all' %}btn-white text-dark{% else %}btn-outline-white{% endif %}">All</a>
              </div>
              <!-- Export -->
              <a href="{% url 'analytics_export_csv' %}?range={{ range }}{% if selected_bot %}&chatbot_id={{ selected_bot.chatbot_id }}{% endif %}"
                 class="btn btn-sm btn-outline-white">
                <i class="material-symbols-rounded align-middle" style="font-size:16px;">download</i> CSV
              </a>
            </div>
          </div>
        </div>

        <div class="card-body px-3 pt-4">
          <!-- Summary Cards -->
          <div class="row mb-4">
            <div class="col-xl-3 col-sm-6 mb-xl-0 mb-3">
              <div class="card border shadow-sm">
                <div class="card-body p-3">
                  <div class="d-flex align-items-center">
                    <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md d-flex align-items-center justify-content-center" style="width:48px;height:48px;">
                      <i class="material-symbols-rounded text-white">chat</i>
                    </div>
                    <div class="ms-3">
                      <p class="text-sm mb-0 text-capitalize text-muted">Conversations</p>
                      <h4 class="mb-0 fw-bold">{{ total_conversations }}</h4>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-xl-3 col-sm-6 mb-xl-0 mb-3">
              <div class="card border shadow-sm">
                <div class="card-body p-3">
                  <div class="d-flex align-items-center">
                    <div class="icon icon-shape bg-gradient-info shadow text-center border-radius-md d-flex align-items-center justify-content-center" style="width:48px;height:48px;">
                      <i class="material-symbols-rounded text-white">message</i>
                    </div>
                    <div class="ms-3">
                      <p class="text-sm mb-0 text-capitalize text-muted">Messages</p>
                      <h4 class="mb-0 fw-bold">{{ total_messages }}</h4>
                      <p class="text-xs text-muted mb-0">{{ user_messages }} user · {{ bot_messages }} bot</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-xl-3 col-sm-6 mb-xl-0 mb-3">
              <div class="card border shadow-sm">
                <div class="card-body p-3">
                  <div class="d-flex align-items-center">
                    <div class="icon icon-shape bg-gradient-warning shadow text-center border-radius-md d-flex align-items-center justify-content-center" style="width:48px;height:48px;">
                      <i class="material-symbols-rounded text-white">star</i>
                    </div>
                    <div class="ms-3">
                      <p class="text-sm mb-0 text-capitalize text-muted">Satisfaction</p>
                      <h4 class="mb-0 fw-bold">{{ avg_satisfaction }}<span class="text-sm text-muted">/5</span></h4>
                      <p class="text-xs text-muted mb-0">{{ feedback_count }} review{{ feedback_count|pluralize }}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-xl-3 col-sm-6 mb-xl-0 mb-3">
              <div class="card border shadow-sm">
                <div class="card-body p-3">
                  <div class="d-flex align-items-center">
                    <div class="icon icon-shape bg-gradient-success shadow text-center border-radius-md d-flex align-items-center justify-content-center" style="width:48px;height:48px;">
                      <i class="material-symbols-rounded text-white">speed</i>
                    </div>
                    <div class="ms-3">
                      <p class="text-sm mb-0 text-capitalize text-muted">Response Rate</p>
                      <h4 class="mb-0 fw-bold">{{ response_rate }}%</h4>
                      <p class="text-xs text-muted mb-0">~{{ avg_messages_per_conv }} msgs/conv</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Leads Collected Card -->
          {% if leads_collected > 0 %}
          <div class="row mb-4">
            <div class="col-xl-4 col-sm-6 mb-3">
              <div class="card border shadow-sm">
                <div class="card-body p-3">
                  <div class="d-flex align-items-center">
                    <div class="icon icon-shape bg-gradient-dark shadow text-center border-radius-md d-flex align-items-center justify-content-center" style="width:48px;height:48px;">
                      <i class="material-symbols-rounded text-white">mail</i>
                    </div>
                    <div class="ms-3">
                      <p class="text-sm mb-0 text-capitalize text-muted">Leads Collected</p>
                      <h4 class="mb-0 fw-bold">{{ leads_collected }}</h4>
                    </div>
                  </div>
                  {% if recent_leads %}
                  <hr class="my-2">
                  <p class="text-xs text-muted mb-1 fw-bold">Recent leads:</p>
                  {% for email in recent_leads %}
                  <span class="badge bg-light text-dark border me-1 mb-1" style="font-size:11px;">{{ email }}</span>
                  {% endfor %}
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          {% endif %}

          <!-- Charts Row 1 -->
          <div class="row mb-4">
            <div class="col-lg-6 mb-4 mb-lg-0">
              <div class="card border shadow-sm h-100">
                <div class="card-header pb-0 bg-white">
                  <h6 class="mb-0"><i class="material-symbols-rounded align-middle me-1 text-primary">show_chart</i> Conversations Over Time</h6>
                </div>
                <div class="card-body p-3">
                  <div style="height:280px;"><canvas id="chart-conversations"></canvas></div>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="card border shadow-sm h-100">
                <div class="card-header pb-0 bg-white">
                  <h6 class="mb-0"><i class="material-symbols-rounded align-middle me-1 text-info">bar_chart</i> Messages Per Day</h6>
                </div>
                <div class="card-body p-3">
                  <div style="height:280px;"><canvas id="chart-messages"></canvas></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Charts Row 2 -->
          <div class="row mb-4">
            <div class="col-lg-6 mb-4 mb-lg-0">
              <div class="card border shadow-sm h-100">
                <div class="card-header pb-0 bg-white">
                  <h6 class="mb-0"><i class="material-symbols-rounded align-middle me-1 text-warning">schedule</i> Peak Usage Hours</h6>
                </div>
                <div class="card-body p-3">
                  <div style="height:280px;"><canvas id="chart-hours"></canvas></div>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="card border shadow-sm h-100">
                <div class="card-header pb-0 bg-white">
                  <h6 class="mb-0"><i class="material-symbols-rounded align-middle me-1 text-success">sentiment_satisfied</i> Satisfaction Distribution</h6>
                </div>
                <div class="card-body p-3">
                  <div style="height:280px;"><canvas id="chart-satisfaction"></canvas></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Top Questions -->
          <div class="row">
            <div class="col-12">
              <div class="card border shadow-sm">
                <div class="card-header pb-0 bg-white">
                  <h6 class="mb-0"><i class="material-symbols-rounded align-middle me-1 text-primary">help</i> Top Questions Asked</h6>
                </div>
                <div class="card-body p-3">
                  <div class="table-responsive">
                    <table class="table table-sm align-items-center mb-0">
                      <thead>
                        <tr>
                          <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">#</th>
                          <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Question</th>
                          <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-center">Times Asked</th>
                        </tr>
                      </thead>
                      <tbody id="top-questions-list">
                        <tr><td colspan="3" class="text-center text-muted py-3">Loading...</td></tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const chartColors = {
    primary: 'rgba(113, 37, 190, 0.8)',
    primaryLight: 'rgba(113, 37, 190, 0.15)',
    primaryBorder: 'rgba(113, 37, 190, 1)',
    info: 'rgba(17, 205, 239, 0.8)',
    success: 'rgba(45, 206, 137, 0.8)',
    warning: 'rgba(251, 140, 0, 0.8)',
    danger: 'rgba(245, 54, 92, 0.8)',
  };

  const baseUrl = '{% url "analytics_chart_data" %}';
  const chatbotId = '{{ selected_bot.chatbot_id|default:"" }}';
  const range = '{{ range }}';

  function buildUrl(chart) {
    let url = `${baseUrl}?chart=${chart}&range=${range}`;
    if (chatbotId) url += `&chatbot_id=${chatbotId}`;
    return url;
  }

  // Chatbot filter dropdown → navigate
  document.getElementById('chatbot-filter').addEventListener('change', function() {
    const val = this.value;
    if (val) {
      window.location.href = `/analytics/${val}/?range=${range}`;
    } else {
      window.location.href = `/analytics/?range=${range}`;
    }
  });

  // Generic chart loader
  function loadChart(canvasId, chartType, fetchChart, options) {
    fetch(buildUrl(fetchChart))
      .then(r => r.json())
      .then(data => {
        if (data.error) return;
        const ctx = document.getElementById(canvasId).getContext('2d');
        const config = {
          type: chartType,
          data: {
            labels: data.labels || [],
            datasets: [{
              label: options.label || '',
              data: data.values || [],
              backgroundColor: options.bgColor || chartColors.primary,
              borderColor: options.borderColor || chartColors.primaryBorder,
              borderWidth: options.borderWidth || 2,
              fill: options.fill || false,
              tension: 0.4,
              pointRadius: options.pointRadius !== undefined ? options.pointRadius : 3,
              pointBackgroundColor: options.borderColor || chartColors.primaryBorder,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: !!options.showLegend },
            },
            scales: chartType === 'doughnut' ? {} : {
              y: { beginAtZero: true, ticks: { precision: 0 } },
              x: { ticks: { maxTicksLimit: 12 } },
            },
          }
        };
        new Chart(ctx, config);
      })
      .catch(err => console.warn('Chart load error:', fetchChart, err));
  }

  // Initialize charts
  document.addEventListener('DOMContentLoaded', function() {
    loadChart('chart-conversations', 'line', 'conversations_over_time', {
      label: 'Conversations',
      fill: true,
      bgColor: chartColors.primaryLight,
      borderColor: chartColors.primaryBorder,
    });

    loadChart('chart-messages', 'bar', 'messages_per_day', {
      label: 'Messages',
      bgColor: chartColors.info,
      borderColor: 'rgba(17, 205, 239, 1)',
      borderWidth: 1,
    });

    loadChart('chart-hours', 'bar', 'peak_hours', {
      label: 'Messages',
      bgColor: chartColors.warning,
      borderColor: 'rgba(251, 140, 0, 1)',
      borderWidth: 1,
    });

    // Satisfaction — doughnut
    fetch(buildUrl('satisfaction_distribution'))
      .then(r => r.json())
      .then(data => {
        if (data.error) return;
        const ctx = document.getElementById('chart-satisfaction').getContext('2d');
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: data.labels,
            datasets: [{
              data: data.values,
              backgroundColor: [chartColors.danger, chartColors.warning, chartColors.info, chartColors.success, chartColors.primary],
              borderWidth: 2,
              borderColor: '#fff',
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true } } },
          }
        });
      });

    // Top questions
    fetch(buildUrl('top_questions'))
      .then(r => r.json())
      .then(data => {
        const container = document.getElementById('top-questions-list');
        if (data.questions && data.questions.length) {
          container.innerHTML = data.questions.map((q, i) =>
            `<tr>
              <td class="text-xs ps-3">${i + 1}</td>
              <td class="text-sm">${escapeHtml(q.text)}</td>
              <td class="text-center"><span class="badge bg-gradient-primary">${q.count}</span></td>
            </tr>`
          ).join('');
        } else {
          container.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">No questions yet</td></tr>';
        }
      });
  });

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>
{% endblock %}

{% block extra_css %}
<style>
  .btn-outline-white {
    color: #fff;
    border: 1px solid rgba(255,255,255,0.5);
  }
  .btn-outline-white:hover {
    background: rgba(255,255,255,0.15);
    color: #fff;
    border-color: #fff;
  }
  .icon-shape {
    border-radius: 0.5rem;
  }
</style>
{% endblock %}
